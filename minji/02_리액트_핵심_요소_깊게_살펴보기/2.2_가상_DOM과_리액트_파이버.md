# 2.2 가상 DOM과 리액트 파이버

### 2.2.1 DOM과 브라우저 렌더링 과정

- 브라우저가 웹사이트 접근 요청을 받고 화면을 그리는 과정

  1. 브라우저가 사용자가 요청한 주소를 방문해 HTML 파일 다운로드
  2. 브라우저의 렌더링 엔진은 HTML을 파싱해 DOM노드로 구성된 트리(DOM)을 만듦
  3. 2번 과정에서 CSS파일을 만나면 해당 CSS파일도 다운로드
  4. 브라우저의 렌더링 엔진은 이 CSS도 파싱해 CSS노드로 구성된 트리(CSSOM)를 만듦
  5. 브라우저는 2번에서 만든 DOM노드를 순회하는데, 사용자 눈에 보이는 노드만 방문함. (트리를 분석하는 과정을 조금이라도 빠르게 하기 위함)
  6. 눈에 보이는 노드를 대상으로 해당 노드에 대한 CSSOM정보를 찾고 여기서 발견한 CSS스타일 정보를 이 노드에 적용.

     - 레이아웃(layout,reflow)
     - 페인팅(painting)

### 2.2.2 가상 DOM의 탄생 배경

SPA(Single Page Application)의 경우 하나의 페이지에서 모든 작업이 일어나기 때문에 요소의 위치를 계산하는 작업이 많이 일어남

개발자가 많은 인터렉션에 모든 DOM의 변경사항을 추적하기 어려움

-> DOM을 관리하는 과정에서 부담이 커짐

가상 DOM을 사용해 웹페이지가 표시해야 할 DOM을 일단 메모리에 저장하고 리액트(react-dom)가 실제 변경에 대한 준비가 완료되었을 때 실제 브라우저의 DOM에 반영

-> 브라우저가 아닌 메모리에서 계산하는 과정을 한번 거쳐 렌더링 과정 최소화, 브라우저와 개발자의 부담 감소

### 2.2.3 가상 DOM을 위한 아키텍처, 리액트 파이버

- 리액트 파이버

  - 리액트에서 관리하는 자바스크립트 객체
  - 파이버는 파이버 재조정자가 관리, 파이버 재조정자는 가상 DOM과 실제 DOM을 비교해 변경 사항 수집, 변경된 정보를 가지고 있는 파이버를 기준으로 화면에 렌더링 요청
  - 기존 리액트에서 사용하던 렌더링 스택의 동기 작업으로 인한 비효율성을 해결하기 위해 파이버라는 개념 탄생
  - 파이버는 하나의 작업 단위로 구성되어 있으며, 이러한 작업 단위를 하나씩 처리하고 finishedWork()라는 작업으로 마무리. 그리고 이 작업을 커밋해 실제 브우저 DOM에 가시적 변경 사항을 만들어냄

- 파이버의 구현

  1. 렌더 단계에서 리액트는 사용자에게 노출되지 않는 모든 비동기 작업 수행 (파이버의 작업, 우선순위 지정 등)
  2. 커밋 단계에서는 DOM에 실제 변경 사항을 반영하기 위한 작업이 실행됨 (동기적으로 일어나고 중단될 수 없음)

  - 리액트 요소는 렌더링이 발생할 때마다 새롭게 생성되지만, 파이버는 가급적이면 재사용됨

  - element와 파이버는 1:1 관계

  - 파이버는 state가 변경되거나 생명주기 메서드가 실행되거나 DOM의 변경이 필요한 시점 등에 실행됨

  - 리액트가 파이버를 처리할 때 작업을 바로 처리하기도 하고, 스케줄링 하기도 함

  -> 리액트는 변수에 UI관련 값을 보관하고, 리액트의 자바스크립트 코드 흐름에 따라 이를 관리하고 표현한다.

- 리액트 파이버 트리

  리액트 내부에는 현재 모습을 담은 파이버 트리와 작업 중인 상태를 나타내는 workInProgress트리 총 2개가 존재함. 리액트 파이버의 작업이 끝나면 리액트는 단순히 포인터만 변경해 workInProgress트리를 현재 트리로 바꿔버림 (더블 버퍼링)

- 파이버의 작업 순서

  1. 리액트는 더이상 자식이 없는 파이버를 만날 때까지, beginWork() 함수를 실행해 파이버 작업 수행
  2. 1번에서 작업이 끝나면 completeWork() 함수를 실행해 파이버 작업을 완료함
  3. 형제가 있다면 형제로 넘어감
  4. 2,3번이 모두 끝나면 return으로 돌아가 자신의 작업이 완료되었음을 알림

### 2.2.4 파이버와 가상 DOM

리액트 파이버는 리액트 네이티브 처럼 브라우자가 아닌 환경에서도 사용할 수 있으므로 파이버와 가상 DOM이 동일한 개념은 아님. 하지만 내부적으로 파이버를 통해 조정되는 과정이 동일하므로 동일한 재조정자 사용 가능

### 2.2.5 정리

가상 DOM과 파이버가 만들어진 이유

1. 브라우저의 DOM을 변경하는 작업보다 빠름
2. 어떤 값이 변경되었고, 이와 관련된 것들이 무엇인지를 개발자 대신 파악해줌

##### 🔗참고 링크

<https://d2.naver.com/helloworld/2690975>
