# **Chapter-12 모든 웹 개발자가 관심을 가져야 할 핵심 지표**
버그가 없고, 비즈니스 로직 처리가 정상적이며, 각종 지표가 안정적일지라도 웹 개발자에게 요구되는 중요한 역할
- 성능에 대한 체감은 사용자별로 천차만별 사용자가 쾌적하게 서비스를 이용하도록 돕는 것도 매우 중요

**학습 목표**
- 웹 서비스의 성능을 측정할 수 있는 핵심 웹 지표 이해
- 리액트 애플리케이션에서 성능을 측정하는 방법에 대해 이해

## Table of contents
- [12-2 핵심 웹 지표란?](#12-2-핵심-웹-지표란)
- [12-3 최대 콘텐츠풀 페인트(LCP)](#12-3-최대-콘텐츠풀-페인트lcp)

## 12-2 핵심 웹 지표란?
핵심 웹 지표(Core Web Vitals)는 구글에서 만든 지표로, 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어 

### 핵심 웹 지표
과거에도 웹사이트의 성능을 측정하기 위한 다양한 도구와 여러 가지 지표가 있었지만 뚜렷한 표준이나 측정 방법이 정해져 있지 않아 일관되게 판단하기 어려움이 따름. 이를 해결하기 위해 구글에서 사이트에서 핵심적인 웹 지표를 요약하고, 이를 측정할 수 있는 방법, 그리고 ‘좋은 웹사이트’로 분류할 수 있는 기준을 명확하게 제시

- **최대 콘텐츠풀 페인트(LCP: Largest Contentful Paint)**
- **최초 입력 지연(FID: First Input Delay)**
- **누적 레이아웃 이동(CLS: Cumulative Layout Shift)**

### 특정 문제를 진단하는 데 사용하는 지표
그리고 핵심까지는 아니지만, 특정 문제를 진단하는 데 사용될 수 있는 두 가지 지표  
- 최초 바이트까지의 시간(TTFB: Time To First Byte)
- 최초 콘텐츠풀 시간(FCP: First Contentful Paint)

---

## 12-3 최대 콘텐츠풀 페인트(LCP)
**최대 콘텐츠풀 페인트(LCP: Largest Contentful Paint)**란 '페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는 데 걸리는 시간'을 말함.

### 큰 이미지와 텍스트 정의
뷰포트는 사용자에게 현재 노출되는 화면을 의미하며, 기기에 따라 뷰포트 크기는 다름.  
뷰포트 내부에서 '큰 이미지와 텍스트'는 다음과 같이 정의됨
- `<img>`
- `<svg>` 내부의 `<image>`
- poster 속성을 사용하는 `<video>`
- url()을 통해 불러온 배경 이미지가 있는 요소
- 블록 레벨 요소 (`<p>`, `<div>` 등)
  - 텍스트와 같이 인라인 텍스트 요소를 포함

> 요약하자면 각 엘리먼트가 등장한 시점부터 텍스트 또는 이미지가 완전히 로딩되는 시점

즉, **최대 콘텐츠풀 페인트(LCP)**란 사용자의 기기가 노출하는 뷰포트 내부에서 가장 큰 영역을 차지하는 요소가 렌더링되는 데 얼마나 걸리는지를 측정하는 지표.  
실제 크기가 크다고 하더라도 뷰포트 영역 밖에 넘치는 요소는 고려되지 않으므로, LCP에 영향을 미치는 부분은 오직 뷰포트 영역뿐임.

### 의미
웹페이지가 로딩이 완료되어 사용자에게 노출되기까지 걸리는 시간을 측정하는 기준은 무엇일까?

#### DOMContentLoaded 이벤트
흔히 DOMContentLoaded 이벤트가 호출되는 시간을 생각하지만, 해당 이벤트로는 개발자가 예상한 페이지 로딩 시간과 사용자가 체감한 페이지 로딩 시간 사이에는 현격한 차이가 있을 것

- DOMContentLoaded는 HTML 문서를 완전히 불러오고 파싱했을 때 발생하는 이벤트
- 페이지의 document를 대상으로 일어나며 단 한 번만 호출됨
- ‘스타일시트, 이미지, 하위 프레임의 로딩은 기다리지 않는다’는 제한이 있음
  - 뷰포트 영역이 대부분 이미지로 이뤄져 있고, 이미지의 크기가 커서 로딩이 오래 걸린다면 유효하지 못함

#### 사용자가 로딩이 완료되었다고 인식하는 시점
사용자에게 로딩이 완료되었다는 인식을 제공하기 위해 모든 페이지가 완전히 로딩될 필요는 없음

- 사용자에게 있어 로딩이란 뷰포트 영역에 보이는 부분이 기준이 됨
- 뷰포트에 메인 콘텐츠가 완전히 전달되는 속도를 기준으로 삼으면, 사용자가 페이지 로딩이 완료됐다고 체감하는 시간과 비슷할 것

> 사용자에게 정보를 화면에 전달하는 속도를 객관적으로 판단하기 위한 지표로 만들어진 것이 **최대 콘텐츠풀 페인트(LCP)**

### 예제
1. 최초에 헤더가 가장 먼저 노출. 그러므로 최대 콘텐츠풀 페인트(LCP)는 헤더.
2. 그다음 바둑판 메뉴가 노출. 이 영역은 헤더보다 크기 때문에 LCP가 헤더에서 이 바둑판 메뉴로 바뀜.
3. 시간이 지나고 콘텐츠가 로딩되면서 LCP는 가운데 사진 영역으로 바뀜.
4. 3번에서 현재 LCP인 영역은 이미지 로딩이 필요한데, 아직 이미지 로딩이 끝나지 않음.
5. 최대 콘텐츠풀 페인트 영역 내부의 이미지 로딩이 마침내 끝나면서 LCP 지표가 기록됨.

### 기준 점수
LCP 등의 각종 지표 점수를 측정하는 방법

- 직접 자바스크립트 API를 호출하는 방법
- 다른 도구를 활용하는 방법

> 손쉬운 측정을 위해서는 대부분 후자를 택함

최대 콘텐츠풀 페인트에서 좋은 점수란 해당 지표가 2.5초 내로 응답이 오는 것  
- 4초 이내로 응답이 온다면 보통, 그 이상이 걸리면 나쁨으로 판단.


### 개선 방안
본격적으로 LCP 점수를 높일 수 있는 방법

#### 텍스트는 언제나 옳다
뷰포트 최대 영역, 즉 LCP 예상 영역에 이미지가 아닌 문자열을 넣는 것

- 이미지를 최적화하더라도 추가적인 리소스 다운로드가 필요한 이미지보다 텍스트 노출이 훨씬 더 빠름

#### 이미지는 어떻게 불러올 것인가?
이미지를 노출하는 방법의 개선

#### `<img>`
- 이미지는 브라우저의 프리로드 스캐너에 의해 먼저 발견되어 빠르게 요청이 이루어짐
  - 프리로드 스캐너는 HTML 파싱하는 단계를 차단하지 않고, 이미지와 미리 로딩하면 좋을 리소스를 찾아 로딩하는 브라우저 기능
- `<img>` 태그 내부의 리소스는 HTML 파싱이 완료되지 않더라도 병렬적으로 다운로드하므로 LCP 요소를 불러오기에 적적한 방법
- `<picture>`도 마찬가지

#### `<svg>`
- `<svg>` 내부의 `<img>`가 로딩이 완료되기 전까지는 최대 콘텐츠풀 페인트가 완료되지 않음 
- 모든 리소스를 다 불러온 이후에 이미지를 불러온다는 것. 이는 `<img>`와 다름

>  즉, `<svg>` 내부의 `<img>` 는 프리로드 스캐너에 의해 발견되지 않아 병렬적으로 다운로드가 일어나지 않음. 이는 결국 최대 콘텐츠풀 페인트 점수에도 악영향을 미치므로 이러한 방식은 삼가는 것이 좋음

#### `<video>`
- poster는 프리로드 스캐너에 의해 조기에 발견되어 <img>와 같은 성능을 나타냄
- video가 LCP에 영향을 받을 것 같다면 poster를 반드시 넣어주는 것이 좋음

#### background-image
background-image는 LCP와 같이 영향을 줄 중요한 리소스에는 사용하지 않는 것이 좋음


### 그 밖에 조심해야 할 사항
- 이미지 무손실 압축
- loading=lazy
- fadeIn과 같은 각종 애니메이션
- 클라이언트에서 빌드하지 말 것

## 12-4 최초 입력 지연(FID)
최초 입력 지연은 사용자가 얼마나 빠르게 웹페이지와의 상호작용에 대한 응답을 받을 수 있는지 측정하는 지표다. 

- 최초의 입력 하나에 대해서만 그 응답 지연이 얼마나 걸리는지를 판단
- 모든 입력에 대해 측정하는 것이 아님


### 의미
웹사이트 내부의 이벤트가 반응이 늦어지는 이유는 메인 스레드가 바쁘기 때문

- 자바스크립트 실행 환경은 '싱글 스레드'이기 때문에 자바스크립트가 이벤트 리스너와 같은 다른 작업을 실행할 수 없어 지연이 발생
- 대규모 렌더링이 일어나거나
- 대규모 자바스크립트 파일을 분석하고 실행하는 등 다른 작업을 처리하는 데 리소스를 할애하고 있기 때문

#### 구글이 정의하는 사용가 경험
구글은 사용자 경험을 크게 4가지로 분류해 정의하는데, 이를 RAIL이라고 한다. 이 RAIL에 해당하는 것들은 다음과 같다.

- Response: 사용자의 입력에 대한 반응 속도. 50ms 미만으로 이벤트를 처리할 것
- Animation: 애니메이션의 각 프레임을 10ms 이하로 생성할 것
- Idle: 유휴 시간을 극대화해 페이지가 50ms 이내에 사용자 입력에 응답하도록 할 것
- Load: 5초 이내에 콘텐츠를 전달하고 인터랙션을 준비할 것

> 이 가운데 최초 입력 지연은 R에 해당하는 응답에 초점을 맞추고 있음

### 예제

### 기준 점수
최초 입력 지연(FID)의 좋은 점수를 얻기 위해서는 100ms 이내로 응답이 와야 하며, 300ms 이내인 경우는 보통, 그 이후의 경우에는 나쁨으로 처리됨

### 개선 방안
즉, 이벤트가 발생하는 시점에 최대한 메인 스레드가 다른 작업을 처리할 수 있도록 여유를 주어야 함

- 실행에 오래 걸리는 긴 작업을 분리
- 자바스크립트 코드 최소화
- 타사 자바스크립트 코드 실행의 지연

## 누적 레이아웃 이동

### 정의
페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표를 계산하는 것이 바로 **누적 레이아웃 이동(CLS: Cumulative Layout Shift)**
- 다른 지표와 마찬가지로 이 지표가 낮을수록, 즉 사용자가 겪는 예상치 못한 레이아웃 이동이 적을수록 더 좋은 웹사이트

### 의미

### 예제

### 기준 점수
- 삽입이 예상 되는 요소를 위한 추가적인 공간 확보
- 폰트로딩 최적화
- 적합한 이미지 크기 설정