# **Chapter-13 웹 페이지의 성능을 측정하는 다양한 방법**
웹페이지의 성능을 객관적으로 확인하기 위한 다양한 지표를 측정하는 방법

- 개발자의 컴퓨터에서 확인하는 방법
- 원격지에 있는 서버에서 확인하는 방법까지 다양

**학습 목표**
- 웹페이지의 성능을 확인하는 다양한 지표를 측정하는 방법 익히기
- 웹페이지의 성능을 객관적으로 파악하기

## Table of contents
- [13-1 애플리케이션에서 확인하기](#13-1-애플리케이션에서-확인하기)
- [13-2 구글 라이트하우스](#13-2-구글-라이트하우스)

## 13-1 애플리케이션에서 확인하기

### create-react-app

#### web-vitals 라이브러리
- 누적 레이아웃 이동(CLS)
- 최초 입력 지연(FID)
- 최초 콘텐츠풀 페인트(FCP)
- 최대 콘텐츠 페인팅(LCP)
- 첫 바이트까지의 시간(TTFB)

> 브라우저에서 웹페이지에서 다양한 성능을 측정하기 위해 PerformanceObserver 라는 API 제공, 해당 API가 없으면 성능 측정 X

#### 성능 데이터를 활용하고 싶다면
- sendBeacon API
- 구글 애널리틱스 활용

---

### create-next-app
Next.js에서도 create-react-app과 비슷한 방식으로 성능 측정을 할 수 있음

#### NextWebVitalsMetric
Next.js는 성능 측정을 할 수 있는 메서드인 NextWebVitalsMetric을 제공

```tsx
import { NextWebVitalsMetric } from 'next/app';

export function reportWebVitals(metric: NextWebVitalsMetric) {
  console.log(metric);
}

function MyApp({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />;
}

export default MyApp;
```

#### Next.js 특화 사용자 지표
주목할 만한 점은 핵심 웹 지표 외에도 Next.js에 특화된 사용자 지표도 제공한다는 점

- Next.js-hydration: 페이지가 서버 사이드에서 렌더링되어 하이드레이션하는 데 걸린 시간
- Next.js-route-change-to-render: 페이지가 경로를 변경한 후 페이지를 렌더링을 시작하는 데 걸리는 시간
- Next.js-render: 경로 변경이 완료된 후 페이지를 렌더링하는 데 걸린 시간

> 어느 정도 이하로 지표가 기록돼야 한다는 등의 기준은 없지만 각각의 지표를 살펴보면서 서버 사이드 렌더링 시에 오래 걸리진 않는지, 페이지 전환 시에 호출되는 getServer-SideProps가 오래 걸리지 않는지 등을 살펴보면 좋음

> 참고로 모든 시간 단위는 밀리초(ms)다.

---

## 13-2 구글 라이트하우스
구글 라이트하우스는 구글에서 제공하는 웹 페이지 성능 측정 도구로, 오픈소스로 운영되고 있음

- 핵심 웹 지표뿐만 아니라 접근성, PWA, SEO 등 웹 페이지를 둘러싼 다양한 요소를 측정하고 점검할 수 있음
- 별도의 애플리케이션 코드 수정이나 배포, 수집 없이도 지표를 수집할 수 있음

### 탐색 모드 - 구글 라이트하우스
페이지 접속했을 때부터 페이지 로딩이 완료될 때까지 성능을 측정하는 모드

#### 성능
성능은 웹페이지의 성능과 관련된 지표를 확인할 수 있는 영역.

핵심 웹 지표 외에도 3가지 추가적인 지표가 있음

- 최초 콘텐츠풀 페인트(FCP)
- 최대 콘텐츠풀 페인트(LCP)
- 누적 레이아웃 이동(CLS)
- **Time to Interactive (TTI)**
- **Speed Index**
- **Total Blocking Time (TBT)**

**Time to Interactive (TTI)**  
페이지에서 사용자가 완전히 상호작용(인터랙션)할 수 있을 때까지 걸리는 시간을 측정
여기서 상호작용에 걸리는 시간까지란 다음과 같은 것을 의미한다.

- 최초 콘텐츠풀 페인트로 측정되는 페이지 내 콘텐츠가 표시되는 시점
- 보여지는 페이지 요소의 대부분에 이벤트 핸들러가 부착되는 시점
- 페이지가 유저의 상호작용에 50ms 내로 응답하는 시점

구글에서는 이 TTI 지표가 3.8초 이내면 좋음, 7.3초 이내면 보통, 그 이후는 개선이 필요한 것으로 봄.

> 웹 페이지가 최대한 빠르게 상호작용이 되도록 준비하려면 메인 스레드가 하는 자바스크립트 작업을 최소화하고, 전체적인 자바스크립트 실행 속도 또한 높일 필요가 있음

**Speed Index**  
페이지가 로드되는 동안 콘텐츠가 얼마나 빨리 시각적으로 표시되는지를 계산. 
구글에서는 이 지표가 3.4초 이내면 좋음, 5.8초 이내면 보통, 그 이후는 느리다고 판단.

> 라이트하우스는 브라우저에서 로드되는 페이지를 실시간으로 캡처하고, Speedline 라이브러리를 사용해 캡처된 이미지를 분석해 Speed Index를 계산

**Total Blocking Time (TBT)**  
이 Total Blocking Time(총 차단 시간)은 긴 작업을 모아서 각각의 긴 작업의 시간에서 50ms를 뺀 다음, 이를 모두 합해 계산.

- TBT는 모든 긴 작업을 대상으로 하는 것이 아니고, 최초에 사용자에게 무언가 콘텐츠를 보여줬을 때(최초 콘텐츠풀 페인트, FCP)부터 상호작용까지 걸리는 시간(TTI) 사이의 작업만 대상으로 함
- 사용자가 무언가 작업이 진행되고 있지 않다는 것을 눈치 챌 수 있는 시간을 대상으로만 총 차단 시간을 구함

> 메인 스레드에서 특정 시간 이상 실행되는 작업, 즉 긴 작업이 수행될 때마다 메인 스레드가 차단된 것으로 간주. 메인 스레드가 차단됐다고 표현하는 이유는 브라우저가 이렇게 길게 실행되는 작업 때문에 무언가 다른 작업을 수행할 수 없기 때문. 이렇게 메인 스레드에서 실행하는 작업이 50ms 이상 걸리면 이를 긴 작업이라고 간주하고, 이렇게 실행되는 긴 작업을 모아서 Total Blocking Time(총 차단 시간)이라고 함.

#### 접근성
다양한 사용자를 배려하기 위해 HTML과 CSS 등에 적절한 대안을 삽입하는 것을 접근성이라고 함

적절하게 접근성을 제공하는지에 따라 평가

#### 권장사항
웹 사이트를 개발할 때 고려해야 할 요소들을 잘 지키는지 확인할 수 있음

- CSP가 XSS 공격에 효과적인지 확인
- 감지된 JavaScript 라이브러리
- HTTPS 사용
- 페이지 로드 시 위치정보 권한 요청 방지하기
- 페이지 로드 시 알림 권한 요청 방지하기
- 알려진 보안 취약점이 있는 프런트엔드 자바스크립트 라이브러리를 사용하지 않음
- 사용자가 비밀번호 입력란에 붙여넣을 수 있도록 허용
- 이미지를 올바른 가로세로 비율로 표시
- 이미지가 적절한 해상도로 제공됨
- 페이지에 HTML Doctype 있음
- 문자 집합을 제대로 정의함
- 지원 중단 API 사용하지 않기
- 콘솔에 로그된 브라우저 오류 없음
- Chrome DevTools의 Issues 패널에 문제없음
- 페이지에 유효한 소스 맵이 있음
- `font-display: optional`을 사용하는 폰트가 미리 로드됨

#### 검색 엔진 최적화
검색엔진 최적화(SEO)란 웹페이지가 구글과 같은 검색엔진이 쉽게 웹페이지 정보를 가져가서 공개할 수 있도록 최적화돼 있는지를 확인하는 것을 의미.

- 문서를 크롤링하기 쉽게 만들었는지
- robots.txt가 유효한지
- 이미지와 링크에 설명 문자가 존재하는지
- `<meta>`나 `<title>` 등으로 페이지의 정보를 빠르게 확인할 수 있는지

> 검색엔진에 최적화돼 있을수록 검색 엔진의 검색결과 우선순위에 높게 나타나며, 사용자가 유입될 가능성이 높아지므로 이러한 검색엔진 최적화를 위한 다양한 요소들을 확인하고 점검할 필요가 있음

### 기간 모드 - 구글 라이트하우스
기간 모드는 실제 웹페이지를 탐색하는 동안 지표를 측정하는 것.

1. 기간 모드 시작을 누른 뒤 성능 측정을 원하는 작업을 수행한 다음
2. 기간 모드를 종료하면, 그 사이에 일어난 작업들에 대한 지표를 확인할 수 있음

기간 모드는 크게 성능과 권장사항으로, 앞서 탐색 모드와 크게 다르지 않음 

> 대다수의 사용자가 빈번하게 수행할 것으로 예상되는 작업을 기간 모드로 측정하면 성능 최적화에 큰 도움을 얻을 수 있음

여기서 앞에서 볼 수 없었던 내용 두 가지를 확인할 수 있는데, 바로 흔적과 트리맵이다.

#### 흔적
흔적이라는 이름은 View Trace를 번역한 것

- 웹 성능을 추적한 기간을 성능 탭에서 보여줌
- 상세하게 시간의 흐름에 따라 어떻게 웹페이지가 로딩됐는지를 보여줌

#### 트리맵
트리맵은 페이지를 불러올 때 함께 로딩한 모든 리소스를 함께 모아서 볼 수 있는 곳. 

- 웹페이지의 전체 자바스크립트 리소스 중 어떠한 파일이 전체 데이터 로딩 중 어느 정도를 차지했는지를 비율로 확인
- 실제 불러온 데이터의 크기를 확인
- 한 가지 더 확인할 수 있는 것은 로딩한 리소스에서 사용하지 않은 바이트의 크기를 확인(실제로 불러왔지만 사용되지 않은 리소스)
  - 특정 시나리오에서만 실행되는 리소스도 있기 때문에 꼭 사용하지 않았다고 해서 불필요한 것이라고 단정 지을 수 없음 
  - 다만 이 사용하지 않은 바이트의 크기가 불필요하게 크다면 번들링된 리소스에서 불필요한 것이 없는지 확인해 보는 것이 좋음

### 스냅샷 - 구글 라이트하우스
스냅샷 모드는 탐색 모드와 매우 유사하지만 현재 페이지 상태를 기준으로 분석한다는 점이 다름

- 현재 상태에서 검색엔진의 최적화, 접근성, 성능 등을 분석
- 페이지 로딩이 아닌 특정 페이지의 특정 상태를 기준으로 분석할 때 사용
- 스냅샷 모드의 지표는 탐색 모드와 매우 유사

